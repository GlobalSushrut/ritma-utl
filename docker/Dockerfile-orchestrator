# BAR orchestrator (window pipeline + sealing via noop proof)
FROM rust:1.88 AS builder
WORKDIR /app
COPY . .
RUN cargo build -p bar_orchestrator --release

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/* && \
    groupadd -r ritma -g 1001 && \
    useradd -r -g ritma -u 1001 -m -d /home/ritma -s /bin/false ritma && \
    mkdir -p /var/lib/ritma /run/ritma/locks && \
    chown -R ritma:ritma /var/lib/ritma /run/ritma
COPY --from=builder --chown=ritma:ritma /app/target/release/bar_orchestrator /usr/local/bin/bar_orchestrator
VOLUME ["/var/lib/ritma"]
USER ritma
ENV INDEX_DB_PATH=/var/lib/ritma/index_db.sqlite
ENV RITMA_BASE_DIR=/var/lib/ritma
ENV RITMA_OUT_DIR=/var/lib/ritma/RITMA_OUT
ENV RITMA_SIDECAR_LOCK_DIR=/run/ritma/locks
ENV NAMESPACE_ID=ns://demo/dev/hello/world
ENV TICK_SECS=60
ENTRYPOINT ["/usr/local/bin/bar_orchestrator"]
