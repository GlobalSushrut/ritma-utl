<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ritma.io/ritma_transparency_forensics/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Forensics Standard - Ritma</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Forensics Standard";
        var mkdocs_page_input_path = "ritma_transparency_forensics.md";
        var mkdocs_page_url = "/ritma_transparency_forensics/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Ritma
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ARCHITECTURE/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../production_setup/">Production Setup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CLI_REFERENCE/">CLI Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../SDK/">SDK Guide</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Forensics Standard</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#status">Status</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#goal">Goal</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scope">Scope</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#industry-standards-to-emulate-short-list">Industry standards to emulate (short list)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-certificate-transparency-ct-append-only-merkle-logs-signed-tree-heads">1) Certificate Transparency (CT): append-only Merkle logs + signed tree heads</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-trillian-leaf-hashing-vs-identity-hash-store-big-blobs-outside-the-log">2) Trillian: leaf hashing vs identity hash + store big blobs outside the log</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-sigstore-rekor-operational-transparency-log-size-limits-sharding">3) Sigstore Rekor: operational transparency log + size limits + sharding</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-cbor-deterministic-encoding">4) CBOR deterministic encoding</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#5-cose-signing">5) COSE signing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#6-scitt-signed-statements-receipts-transparency-service-model">6) SCITT: signed statements + receipts + transparency service model</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#7-nist-chain-of-custody-definition">7) NIST chain-of-custody definition</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ritma-design-principles-derived-from-standards">Ritma design principles (derived from standards)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#a-transparency-log-stores-commitments-not-full-data">A) Transparency log stores commitments, not full data</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#b-evidenceartifacts-are-content-addressed-and-referenced-by-hash">B) Evidence/artifacts are content-addressed and referenced by hash</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#c-deterministic-canonicalization-everywhere">C) Deterministic canonicalization everywhere</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#d-simple-responder-ux">D) Simple responder UX</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#target-oneminute-page-model">Target “One‑Minute Page” model</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#what-the-page-contains">What the page contains</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#where-each-part-lives">Where each part lives</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mapping-to-current-ritma-code">Mapping to current Ritma code</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#capture">Capture</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#window-processing-sealing">Window processing + sealing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ledger-output-format">Ledger output format</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#proofpack-export">Proofpack export</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#known-gaps-what-must-change">Known gaps (what must change)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-snapshot-must-include-the-real-trace-excerpt">1) Snapshot must include the real trace excerpt</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-snapshotter-returns-only-hashesmetadata-not-persisted-artifacts">2) Snapshotter returns only hashes/metadata, not persisted artifacts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-export-should-not-require-ml-id">3) Export should not require ML id</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-rtsl-only-should-be-the-default-for-production">4) RTSL-only should be the default for production</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#5-retention-should-be-explicit-and-safe">5) Retention should be explicit and safe</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#recommended-implementation-plan-in-repo">Recommended implementation plan (in repo)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#phase-1-correctness">Phase 1 (correctness)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#phase-2-forensic-usability">Phase 2 (forensic usability)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#phase-3-evidence-store">Phase 3 (evidence store)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#phase-4-transparency-hardening">Phase 4 (transparency hardening)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#environment-recommendations">Environment recommendations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#success-criteria">Success criteria</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#chain-of-custody-coc-industry-standard-requirements">Chain-of-Custody (CoC) — Industry-Standard Requirements</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#coc-principle-1-no-action-should-change-evidence">CoC Principle 1: No action should change evidence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#coc-principle-2-competent-persons-access-evidence-with-audit-trail">CoC Principle 2: Competent persons access evidence with audit trail</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#coc-principle-3-audit-trail-enables-third-party-replication">CoC Principle 3: Audit trail enables third-party replication</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#coc-principle-4-investigation-leader-ensures-legal-compliance">CoC Principle 4: Investigation leader ensures legal compliance</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#secure-deletion-after-sealing-tamper-evident-pruning">Secure Deletion After Sealing — Tamper-Evident Pruning</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#problem">Problem</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#industry-guidance">Industry guidance</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ritma-secure-deletion-policy">Ritma secure deletion policy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exploitation-prevention">Exploitation prevention</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cryptographic-erasure-future">Cryptographic erasure (future)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#custody-log-schema">Custody Log Schema</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rfc-3161-timestamping-optional">RFC 3161 Timestamping (Optional)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cose-receipts-for-rtsl-future">COSE Receipts for RTSL (Future)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#summary-ritma-coc-compliance-matrix">Summary: Ritma CoC Compliance Matrix</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#-">---</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../RTSL_SPEC/">RTSL Spec</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../EEC_SPEC/">EEC Spec</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Ritma</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Forensics Standard</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="ritma-transparency-log-forensics-oneminute-page-industry-standard-design">Ritma Transparency Log + Forensics “One‑Minute Page” (Industry-Standard Design)</h1>
<h2 id="status">Status</h2>
<p>Draft.</p>
<h2 id="goal">Goal</h2>
<p>Define an <strong>industry-standard</strong>, <strong>tamper-evident</strong>, <strong>operator-friendly</strong> architecture for Ritma such that for each namespace and each 60s window you can produce a single forensic “page” that:</p>
<ul>
<li><strong>Reflects exactly what the sensor recorded</strong> (the window’s <code>TraceEvent</code>s)</li>
<li>Includes BAR outputs (features, graph, ML, verdict, snapshot manifest)</li>
<li>Is <strong>sealed</strong> into an append-only transparency ledger (RTSL)</li>
<li>Can be exported into a <strong>portable proofpack</strong> (human-usable forensic bundle)</li>
<li>Supports <strong>retention/pruning</strong> of hot storage without losing auditability</li>
</ul>
<h2 id="scope">Scope</h2>
<ul>
<li>Linux runtime capture (<code>tracer_sidecar</code>)</li>
<li>Storage (<code>index_db.sqlite</code>) as hot/cold path</li>
<li>Window processing and sealing (<code>bar_orchestrator</code> + <code>ritma_contract</code>)</li>
<li>Ledger format (<code>RTSL</code>)</li>
<li>Export + verification UX (<code>ritma_cli</code>)</li>
</ul>
<p>Not covered here: multi-tenant SaaS control plane, remote transparency gossip network, legal admissibility procedures beyond technical chain-of-custody.</p>
<hr />
<h2 id="industry-standards-to-emulate-short-list">Industry standards to emulate (short list)</h2>
<h3 id="1-certificate-transparency-ct-append-only-merkle-logs-signed-tree-heads">1) Certificate Transparency (CT): append-only Merkle logs + signed tree heads</h3>
<p>CT defines a Merkle tree with <strong>domain separation</strong> for leaf vs node hashing, and uses <strong>Signed Tree Heads (STHs)</strong> and <strong>consistency proofs</strong> to detect equivocation.</p>
<ul>
<li><strong>Merkle tree + domain separation</strong> (leaf uses <code>HASH(0x00 || leaf)</code>; node uses <code>HASH(0x01 || left || right)</code>) — RFC 9162 §2.1.1</li>
<li>https://www.rfc-editor.org/rfc/rfc9162.html</li>
<li><strong>Signed Tree Head (STH)</strong> (tree_size, root_hash, timestamp, signature) + consistency proof structure — RFC 9162 §4.9–4.11</li>
</ul>
<p>Why it matters for Ritma:
- RTSL is effectively a <strong>local transparency log</strong> for window commitments.
- “Hour roots / chain roots” are analogous to CT tree heads.</p>
<h3 id="2-trillian-leaf-hashing-vs-identity-hash-store-big-blobs-outside-the-log">2) Trillian: leaf hashing vs identity hash + store big blobs outside the log</h3>
<p>Trillian guidance separates:
- <strong>Merkle hash</strong>: what is committed into the transparency log
- <strong>Identity hash</strong>: optional dedupe semantics</p>
<p>It also recommends storing large/private blobs outside the transparency log and logging only hashes.</p>
<ul>
<li>Leaf hashing and separate identity hash — Trillian “Transparent Logging: A Guide”</li>
<li>https://raw.githubusercontent.com/google/trillian/master/docs/TransparentLogging.md</li>
</ul>
<p>Why it matters for Ritma:
- Don’t stuff raw <code>TraceEvent</code>s inside RTSL; store them in a <strong>content-addressed evidence store</strong> (or DB) and commit only canonical hashes.</p>
<h3 id="3-sigstore-rekor-operational-transparency-log-size-limits-sharding">3) Sigstore Rekor: operational transparency log + size limits + sharding</h3>
<p>Rekor is a transparency log for signed metadata and highlights operational constraints (e.g., entry size limits, sharding).</p>
<ul>
<li>Rekor v1 public instance + API endpoints + size limits — Rekor README</li>
<li>https://raw.githubusercontent.com/sigstore/rekor/main/README.md</li>
</ul>
<p>Why it matters for Ritma:
- Proofpacks / “pages” must remain reasonably sized; large artifacts should be referenced by hash.</p>
<h3 id="4-cbor-deterministic-encoding">4) CBOR deterministic encoding</h3>
<p>Deterministic encodings are a standard technique to ensure canonical hashes are stable across implementations.</p>
<ul>
<li>Deterministic CBOR encoding requirements — RFC 8949 §4.2</li>
<li>https://www.rfc-editor.org/rfc/rfc8949.html</li>
</ul>
<p>Why it matters for Ritma:
- <code>canonical_leaf_hash()</code> must be based on deterministic encoding.
- Proofpacks should use canonical encoding to keep hashes stable.</p>
<h3 id="5-cose-signing">5) COSE signing</h3>
<p>COSE provides standard signed container formats for CBOR payloads.</p>
<ul>
<li>COSE signing structures — RFC 9052 §4</li>
<li>https://www.rfc-editor.org/rfc/rfc9052.html</li>
</ul>
<p>Why it matters for Ritma:
- RTSL signatures and proofpack signatures should follow consistent signing semantics.</p>
<h3 id="6-scitt-signed-statements-receipts-transparency-service-model">6) SCITT: signed statements + receipts + transparency service model</h3>
<p>SCITT defines a general model for signed statements registered with a transparency service, producing receipts that can be audited.</p>
<ul>
<li>SCITT architecture overview — draft-ietf-scitt-architecture §5</li>
<li>https://datatracker.ietf.org/doc/html/draft-ietf-scitt-architecture</li>
</ul>
<p>Why it matters for Ritma:
- A “one-minute page” can be treated as a <strong>signed statement</strong> (about a window) with a <strong>receipt</strong> (RTSL inclusion/consistency material).</p>
<h3 id="7-nist-chain-of-custody-definition">7) NIST chain-of-custody definition</h3>
<p>For forensic credibility, maintain chain-of-custody metadata.</p>
<ul>
<li>NIST definition (CSRC glossary)</li>
<li>https://csrc.nist.gov/glossary/term/chain_of_custody</li>
</ul>
<p>Why it matters for Ritma:
- Proofpacks should include who/what produced the page, when, and under what configuration.</p>
<hr />
<h2 id="ritma-design-principles-derived-from-standards">Ritma design principles (derived from standards)</h2>
<h3 id="a-transparency-log-stores-commitments-not-full-data">A) Transparency log stores <strong>commitments</strong>, not full data</h3>
<ul>
<li>RTSL should store:</li>
<li>time window boundaries</li>
<li>tree_size / counts</li>
<li>Merkle root of canonical leaf hashes</li>
<li>linkage to previous heads (hour root / chain root)</li>
<li>signatures</li>
</ul>
<h3 id="b-evidenceartifacts-are-content-addressed-and-referenced-by-hash">B) Evidence/artifacts are <strong>content-addressed</strong> and referenced by hash</h3>
<ul>
<li>Keep large/private artifacts in:</li>
<li><code>RITMA_OUT/cases/&lt;case_id&gt;/...</code> (or another CAS)</li>
<li>or a DB/object store</li>
<li>RTSL commits hashes.</li>
</ul>
<h3 id="c-deterministic-canonicalization-everywhere">C) Deterministic canonicalization everywhere</h3>
<ul>
<li>Leaf hash canonical tuple (already in <code>bar_orchestrator::canonical_leaf_hash</code>)</li>
<li>Canonical CBOR for proofpack files</li>
</ul>
<h3 id="d-simple-responder-ux">D) Simple responder UX</h3>
<p>A responder should be able to do:</p>
<ul>
<li><strong>Seal</strong> continuously</li>
<li><strong>Export one window</strong> (by time range) into a “page/proofpack” directory</li>
<li><strong>Verify</strong> proofpack against RTSL (and optionally against remote witness)</li>
</ul>
<hr />
<h2 id="target-oneminute-page-model">Target “One‑Minute Page” model</h2>
<h3 id="what-the-page-contains">What the page contains</h3>
<p>For a window <code>[start,end]</code> and namespace <code>ns</code>:</p>
<ol>
<li><strong>Trace excerpt (sensor truth)</strong></li>
<li>list of <code>TraceEvent</code>s in the window</li>
<li>
<p>possibly redacted (hash-only mode)</p>
</li>
<li>
<p><strong>BAR derived outputs</strong></p>
</li>
<li>window features summary</li>
<li>attack graph edges + graph hash</li>
<li>ML score + explanation</li>
<li>
<p>verdict + reasons</p>
</li>
<li>
<p><strong>Evidence pack manifest</strong></p>
</li>
<li>list of artifact blobs with <code>sha256</code> (or stronger hash)</li>
<li>
<p>privacy redactions</p>
</li>
<li>
<p><strong>Ledger receipt</strong></p>
</li>
<li>RTSL record reference (segment id / hour root / chain root)</li>
<li>signatures</li>
<li>
<p>(future) inclusion/consistency proofs</p>
</li>
<li>
<p><strong>Chain-of-custody metadata</strong></p>
</li>
<li>node_id, sensor version, config hash, signer id</li>
</ol>
<h3 id="where-each-part-lives">Where each part lives</h3>
<ul>
<li><strong>Hot path</strong>: <code>index_db.sqlite</code> (queryable, pruneable)</li>
<li><strong>Transparency ledger</strong>: RTSL (<code>RITMA_OUT/ledger/v2/...</code>) commits roots</li>
<li><strong>Evidence store</strong>: proofpack/case directory containing files, referenced by hash</li>
</ul>
<p>This mirrors Trillian guidance: log the hash; store large data separately.</p>
<hr />
<h2 id="mapping-to-current-ritma-code">Mapping to current Ritma code</h2>
<h3 id="capture">Capture</h3>
<ul>
<li><code>crates/tracer_sidecar</code> produces <code>common_models::TraceEvent</code></li>
<li>Inserts into <code>IndexDb::insert_trace_event_from_model()</code></li>
</ul>
<h3 id="window-processing-sealing">Window processing + sealing</h3>
<ul>
<li><code>crates/bar_orchestrator::Orchestrator::run_window()</code></li>
<li>Correlate window (features + attack graph)</li>
<li>Run ML</li>
<li>Judge</li>
<li>Snapshot (optional)</li>
<li>Seal (proof metadata + receipts)</li>
<li>Write <code>RITMA_OUT</code> via <code>StorageContract::write_window_output()</code></li>
</ul>
<h3 id="ledger-output-format">Ledger output format</h3>
<ul>
<li><code>crates/ritma_contract::StorageContract::write_window_output()</code></li>
<li><code>RITMA_OUT_FORMAT=legacy|rtsl|dual</code></li>
<li><code>RITMA_OUT_ENFORCE_RTSL=1</code> forces RTSL</li>
</ul>
<h3 id="proofpack-export">Proofpack export</h3>
<ul>
<li><code>crates/ritma_cli</code> has export functions that read IndexDB (events/features/ml/etc.) and write canonical CBOR files.</li>
</ul>
<hr />
<h2 id="known-gaps-what-must-change">Known gaps (what must change)</h2>
<h3 id="1-snapshot-must-include-the-real-trace-excerpt">1) Snapshot must include the real trace excerpt</h3>
<p><strong>Bug fixed</strong>: <code>bar_orchestrator</code> previously called snapshotter with <code>&amp;[]</code>. It must pass the actual <code>trace_events</code> excerpt for <code>[start,end]</code>.</p>
<h3 id="2-snapshotter-returns-only-hashesmetadata-not-persisted-artifacts">2) Snapshotter returns only hashes/metadata, not persisted artifacts</h3>
<p>Today snapshotter computes artifact hashes but does not write the artifact payloads into an evidence store. Industry standard practice is:
- write artifacts to a content-addressed store
- log the hashes + metadata in the manifest</p>
<h3 id="3-export-should-not-require-ml-id">3) Export should not require ML id</h3>
<p>UX should allow:
- <code>ritma export-window --namespace ... --start ... --end ...</code> producing one proofpack</p>
<h3 id="4-rtsl-only-should-be-the-default-for-production">4) RTSL-only should be the default for production</h3>
<p>If RTSL is the standard, deployments should enforce it (and optionally disallow legacy output).</p>
<h3 id="5-retention-should-be-explicit-and-safe">5) Retention should be explicit and safe</h3>
<p>Pruning <code>trace_events</code> must happen only after:
- RTSL record exists
- proofpack/evidence is exported or copied to long-term storage</p>
<hr />
<h2 id="recommended-implementation-plan-in-repo">Recommended implementation plan (in repo)</h2>
<h3 id="phase-1-correctness">Phase 1 (correctness)</h3>
<ul>
<li>Ensure <code>bar_orchestrator</code> passes real per-window <code>trace_excerpt</code> to snapshotter.</li>
<li>Enforce RTSL-only in production configurations.</li>
</ul>
<h3 id="phase-2-forensic-usability">Phase 2 (forensic usability)</h3>
<ul>
<li>Add a <strong>window export</strong> command that generates the “one-minute page” proofpack directly from <code>(namespace,start,end)</code>.</li>
<li>Include the <strong>trace excerpt</strong> file in the proofpack (canonical CBOR).</li>
</ul>
<h3 id="phase-3-evidence-store">Phase 3 (evidence store)</h3>
<ul>
<li>Implement snapshot artifact persistence to an evidence store (e.g., <code>RITMA_OUT/cases/&lt;case_id&gt;/...</code>).</li>
<li>Proofpack references should be hash-addressed.</li>
</ul>
<h3 id="phase-4-transparency-hardening">Phase 4 (transparency hardening)</h3>
<ul>
<li>Add verifiable inclusion/consistency proof material for RTSL (CT-like proofs).</li>
<li>Add witness/gossip support (future).</li>
</ul>
<hr />
<h2 id="environment-recommendations">Environment recommendations</h2>
<p>For production-grade “RTSL standard” deployments:</p>
<ul>
<li><code>RITMA_OUT_ENABLE=1</code></li>
<li><code>RITMA_OUT_FORMAT=rtsl</code></li>
<li><code>RITMA_OUT_ENFORCE_RTSL=1</code></li>
</ul>
<hr />
<h2 id="success-criteria">Success criteria</h2>
<ul>
<li>Given a window <code>[start,end]</code>, exported proofpack contains:</li>
<li><code>trace_events.cbor</code> (what sidecar recorded)</li>
<li><code>attack_graph.cbor</code>, <code>coverage.cbor</code>, <code>ml_score</code>, <code>verdict</code></li>
<li><code>manifest.cbor</code></li>
<li>Verification confirms:</li>
<li>proofpack hashes match IndexDB records</li>
<li>merkle root matches RTSL record for that window</li>
</ul>
<hr />
<h2 id="chain-of-custody-coc-industry-standard-requirements">Chain-of-Custody (CoC) — Industry-Standard Requirements</h2>
<p>This section defines Ritma's chain-of-custody architecture for <strong>military</strong>, <strong>critical infrastructure</strong>, <strong>financial</strong>, and <strong>court-admissible</strong> forensic contexts. It draws from:</p>
<ul>
<li><strong>ACPO/NPCC Good Practice Guide</strong> (UK digital evidence principles)</li>
<li><strong>ISO/IEC 27037:2012</strong> — identification, collection, acquisition, preservation of digital evidence</li>
<li><strong>ISO/IEC 27041:2015</strong> — assuring suitability of investigative methods</li>
<li><strong>ISO/IEC 27042:2015</strong> — analysis and interpretation of digital evidence</li>
<li><strong>ISO/IEC 27043:2015</strong> — incident investigation principles and processes</li>
<li><strong>NIST SP 800-86</strong> — integrating forensic techniques into incident response</li>
<li><strong>NISTIR 8387</strong> — digital evidence preservation for evidence handlers</li>
<li><strong>NIST SP 800-88 Rev.1</strong> — media sanitization (secure deletion)</li>
<li><strong>RFC 3161</strong> — Time-Stamp Protocol (TSP) for evidence timestamping</li>
<li><strong>IETF COSE Merkle Tree Proofs</strong> (draft-ietf-cose-merkle-tree-proofs) — receipts for transparency logs</li>
</ul>
<h3 id="coc-principle-1-no-action-should-change-evidence">CoC Principle 1: No action should change evidence</h3>
<p><strong>Standard</strong>: ACPO Principle 1 / ISO 27037 §7.1.1</p>
<p><strong>Ritma implementation</strong>:
- <code>tracer_sidecar</code> captures events in <strong>append-only</strong> mode; no modification of raw events after insertion.
- <code>index_db</code> uses <strong>hash chaining</strong> (<code>event_hash</code>, <code>prev_hash</code>) so any tampering breaks the chain.
- RTSL commits <strong>Merkle roots</strong> of sealed windows; once sealed, the window's hash is immutable.</p>
<h3 id="coc-principle-2-competent-persons-access-evidence-with-audit-trail">CoC Principle 2: Competent persons access evidence with audit trail</h3>
<p><strong>Standard</strong>: ACPO Principle 2 / ISO 27037 §7.1.2 / UK MoJ POL.POP.009–011</p>
<p><strong>Ritma implementation</strong>:
- Every custody-relevant action is logged to a <strong>custody_log</strong> table:
  - <code>CAPTURE</code> — sidecar inserted events
  - <code>SEAL</code> — bar_orchestrator sealed window into RTSL
  - <code>EXPORT</code> — proofpack exported
  - <code>PRUNE</code> — hot data deleted after seal
  - <code>VERIFY</code> — proofpack verified
- Each log entry includes:
  - <code>timestamp</code> (RFC 3339, ideally RFC 3161 TSA-signed)
  - <code>actor_id</code> (node_id / user / service principal)
  - <code>action</code>
  - <code>target</code> (namespace, window_id, artifact hash)
  - <code>prev_log_hash</code> (hash chain for tamper detection)
  - <code>signature</code> (optional, for high-assurance deployments)</p>
<h3 id="coc-principle-3-audit-trail-enables-third-party-replication">CoC Principle 3: Audit trail enables third-party replication</h3>
<p><strong>Standard</strong>: ACPO Principle 3 / ISO 27043 §6.3 / UK MoJ POL.POP.009</p>
<p><strong>Ritma implementation</strong>:
- Proofpacks include:
  - <code>custody_log.cbor</code> — excerpt of custody events for that window
  - <code>manifest.cbor</code> — artifact hashes + metadata
  - <code>rtsl_receipt.cbor</code> — RTSL inclusion proof (Merkle path + signed tree head)
- A third party can:
  1. Verify <code>trace_events.cbor</code> hash matches manifest
  2. Verify manifest hash matches RTSL leaf
  3. Verify RTSL inclusion proof against signed tree head
  4. Verify custody_log hash chain is unbroken</p>
<h3 id="coc-principle-4-investigation-leader-ensures-legal-compliance">CoC Principle 4: Investigation leader ensures legal compliance</h3>
<p><strong>Standard</strong>: ACPO Principle 4 / ISO 27041 / UK MoJ POL.POP.014</p>
<p><strong>Ritma implementation</strong>:
- Ritma provides <strong>technical controls</strong>; legal/procedural compliance is the operator's responsibility.
- Configuration options:
  - <code>RITMA_COC_REQUIRE_SIGNATURE=1</code> — require cryptographic signature on custody log entries
  - <code>RITMA_COC_TSA_URL=...</code> — RFC 3161 Time-Stamp Authority for external timestamping
  - <code>RITMA_COC_RETENTION_DAYS=...</code> — minimum retention before pruning allowed</p>
<hr />
<h2 id="secure-deletion-after-sealing-tamper-evident-pruning">Secure Deletion After Sealing — Tamper-Evident Pruning</h2>
<h3 id="problem">Problem</h3>
<p>Storing all raw <code>TraceEvent</code>s indefinitely is impractical for high-volume deployments. However, deleting evidence without proper controls could:
1. <strong>Destroy forensic value</strong> before it's needed
2. <strong>Enable cover-ups</strong> by malicious insiders
3. <strong>Violate retention regulations</strong> (PIPEDA 2yr, Québec Law 25 5yr, etc.)</p>
<h3 id="industry-guidance">Industry guidance</h3>
<ul>
<li><strong>NIST SP 800-88 Rev.1</strong>: Sanitization must be <strong>verified</strong> and <strong>documented</strong>. Cryptographic erasure (deleting keys) is acceptable if keys are irreversibly destroyed.</li>
<li><strong>ISO 27037 §7.4</strong>: Preservation includes documenting any changes to evidence, including destruction.</li>
<li><strong>UK MoJ POL.POP.013</strong>: Forensic Readiness Plan must include secure disposal procedures.</li>
</ul>
<h3 id="ritma-secure-deletion-policy">Ritma secure deletion policy</h3>
<p><strong>Rule</strong>: Raw data in <code>index_db</code> may be pruned <strong>only after</strong>:
1. The window is <strong>sealed</strong> into RTSL (Merkle root committed)
2. A <strong>custody_log entry</strong> of type <code>PRUNE</code> is recorded with:
   - window boundaries
   - count of events deleted
   - hash of deleted data (for audit)
   - reference to RTSL seal record
3. (Optional) Proofpack has been <strong>exported</strong> to long-term storage</p>
<p><strong>Implementation</strong>:</p>
<pre><code>index_db.prune_sealed_window(namespace, window_id) -&gt; PruneResult
  1. Verify window_id exists in RTSL (sealed)
  2. Compute hash of events to be deleted
  3. Insert custody_log entry (action=PRUNE, target=window_id, data_hash=...)
  4. DELETE FROM trace_events WHERE namespace=? AND ts &gt;= start AND ts &lt;= end
  5. Return PruneResult { events_deleted, custody_log_id }
</code></pre>
<p><strong>Guardrails</strong>:
- <code>RITMA_PRUNE_REQUIRE_SEAL=1</code> (default) — prune fails if window not sealed
- <code>RITMA_PRUNE_REQUIRE_EXPORT=1</code> — prune fails if proofpack not exported
- <code>RITMA_PRUNE_MIN_AGE_HOURS=24</code> — minimum age before pruning allowed</p>
<h3 id="exploitation-prevention">Exploitation prevention</h3>
<table>
<thead>
<tr>
<th>Attack vector</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Attacker deletes events before seal</td>
<td><code>prune_sealed_window</code> checks RTSL seal exists; fails otherwise</td>
</tr>
<tr>
<td>Attacker modifies custody_log</td>
<td>custody_log uses hash chaining; any gap/modification detectable</td>
</tr>
<tr>
<td>Attacker replays old seal to justify deletion</td>
<td>RTSL seal includes timestamp; prune checks seal_ts &lt; prune_ts</td>
</tr>
<tr>
<td>Attacker with DB access deletes directly</td>
<td>custody_log is append-only; missing entries detectable by hash chain gaps</td>
</tr>
<tr>
<td>Attacker deletes custody_log</td>
<td>custody_log can be replicated to external witness / SIEM; gaps detectable</td>
</tr>
</tbody>
</table>
<h3 id="cryptographic-erasure-future">Cryptographic erasure (future)</h3>
<p>For deployments requiring NIST 800-88 "Purge" level:
- Encrypt <code>trace_events</code> with per-window key
- Store key in HSM or secure enclave
- Pruning = delete key (cryptographic erasure)
- Custody_log records key deletion event</p>
<hr />
<h2 id="custody-log-schema">Custody Log Schema</h2>
<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS custody_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ts TEXT NOT NULL,                    -- RFC 3339 timestamp
    actor_id TEXT NOT NULL,              -- node_id / user / service
    action TEXT NOT NULL,                -- CAPTURE|SEAL|EXPORT|PRUNE|VERIFY|ACCESS
    namespace_id TEXT,
    window_id TEXT,
    target_hash TEXT,                    -- hash of affected data
    details TEXT,                        -- JSON metadata
    prev_log_hash TEXT,                  -- hash chain
    log_hash TEXT NOT NULL,              -- hash of this entry
    signature TEXT,                      -- optional cryptographic signature
    tsa_token BLOB                       -- optional RFC 3161 timestamp token
);
CREATE INDEX IF NOT EXISTS idx_custody_log_ns_ts ON custody_log(namespace_id, ts);
CREATE INDEX IF NOT EXISTS idx_custody_log_action ON custody_log(action);
</code></pre>
<hr />
<h2 id="rfc-3161-timestamping-optional">RFC 3161 Timestamping (Optional)</h2>
<p>For court-admissible evidence, external timestamping proves evidence existed at a specific time:</p>
<ol>
<li>Compute hash of sealed window (or custody_log entry)</li>
<li>Send <code>TimeStampReq</code> to TSA (e.g., FreeTSA, DigiCert, Entrust)</li>
<li>Receive <code>TimeStampResp</code> containing signed timestamp token</li>
<li>Store token in <code>custody_log.tsa_token</code> or proofpack</li>
</ol>
<p><strong>Configuration</strong>:
- <code>RITMA_TSA_URL=https://freetsa.org/tsr</code> (example)
- <code>RITMA_TSA_HASH_ALG=SHA-256</code></p>
<hr />
<h2 id="cose-receipts-for-rtsl-future">COSE Receipts for RTSL (Future)</h2>
<p>IETF draft-ietf-cose-merkle-tree-proofs defines CBOR-encoded receipts for transparency logs:</p>
<ul>
<li><strong>Inclusion proof</strong>: proves a leaf is in the Merkle tree</li>
<li><strong>Consistency proof</strong>: proves tree grew append-only</li>
</ul>
<p>Ritma can adopt this format for <code>rtsl_receipt.cbor</code>:</p>
<pre><code class="language-cbor">{
  &quot;vds&quot;: 1,                    // RFC9162_SHA256
  &quot;tree_size&quot;: 12345,
  &quot;root&quot;: h'...',              // 32-byte root hash
  &quot;leaf_index&quot;: 42,
  &quot;inclusion_path&quot;: [h'...', h'...', ...],
  &quot;signature&quot;: h'...'          // COSE_Sign1
}
</code></pre>
<hr />
<h2 id="summary-ritma-coc-compliance-matrix">Summary: Ritma CoC Compliance Matrix</h2>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Standard</th>
<th>Ritma Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>Append-only evidence capture</td>
<td>ISO 27037, ACPO P1</td>
<td>hash-chained trace_events</td>
</tr>
<tr>
<td>Tamper-evident ledger</td>
<td>CT, SCITT</td>
<td>RTSL Merkle tree + signed roots</td>
</tr>
<tr>
<td>Audit trail for all actions</td>
<td>ACPO P2-3, ISO 27043</td>
<td>custody_log table</td>
</tr>
<tr>
<td>Secure deletion with proof</td>
<td>NIST 800-88, ISO 27037</td>
<td>prune_sealed_window + custody_log</td>
</tr>
<tr>
<td>External timestamping</td>
<td>RFC 3161</td>
<td>TSA integration (optional)</td>
</tr>
<tr>
<td>Portable evidence bundle</td>
<td>ISO 27042</td>
<td>proofpack export</td>
</tr>
<tr>
<td>Third-party verification</td>
<td>ACPO P3</td>
<td>inclusion proofs + hash verification</td>
</tr>
</tbody>
</table>
<h2 id="-">---</h2>
<h1 id="ritma-v2-forensic-page-standard-normative-specification">Ritma v2 Forensic Page Standard (Normative Specification)</h1>
<p><strong>Status</strong>: Draft Normative<br />
<strong>Version</strong>: 2.0<br />
<strong>Applies to</strong>: RTSL, Proofpack, CAS, Custody Log</p>
<p>This section defines the <strong>exact bytes-on-disk</strong>, <strong>exact hashes/signatures</strong>, and <strong>exact file names</strong> for Ritma forensic evidence. Implementations MUST NOT deviate from this specification.</p>
<hr />
<h2 id="1-window-page-the-canonical-signed-statement">1. Window Page: The Canonical Signed Statement</h2>
<h3 id="11-window_pagecbor-the-scitt-like-statement">1.1 <code>window_page.cbor</code> — The SCITT-like Statement</h3>
<p>The <strong>window page</strong> is the single canonical object that everything else references. It is a <strong>signed statement</strong> (SCITT-shaped) that commits to all evidence for a one-minute window.</p>
<p><strong>Encoding</strong>: Deterministic CBOR (RFC 8949 §4.2)<br />
<strong>Map key ordering</strong>: Lexicographic by UTF-8 bytes<br />
<strong>Integer encoding</strong>: Minimal bytes<br />
<strong>Float encoding</strong>: Shortest form preserving value</p>
<h4 id="111-canonical-cbor-map-structure">1.1.1 Canonical CBOR Map Structure</h4>
<pre><code class="language-cbor">{
  &quot;v&quot;: 2,                                    ; page format version (integer)
  &quot;ns&quot;: &quot;&lt;namespace_id&gt;&quot;,                    ; namespace URI (tstr)
  &quot;win&quot;: {                                   ; window boundaries
    &quot;id&quot;: &quot;&lt;window_id&gt;&quot;,                     ; UUID (tstr)
    &quot;start&quot;: &quot;&lt;RFC3339&gt;&quot;,                    ; window start (tstr)
    &quot;end&quot;: &quot;&lt;RFC3339&gt;&quot;                       ; window end (tstr)
  },
  &quot;sensor&quot;: {                                ; sensor identity
    &quot;node_id&quot;: &quot;&lt;RITMA_NODE_ID&gt;&quot;,            ; node identifier (tstr)
    &quot;tracer_ver&quot;: &quot;&lt;semver&gt;&quot;,                ; tracer_sidecar version (tstr)
    &quot;bar_ver&quot;: &quot;&lt;semver&gt;&quot;                    ; bar_orchestrator version (tstr)
  },
  &quot;cfg&quot;: {                                   ; configuration hashes
    &quot;config_hash&quot;: &quot;&lt;sha256&gt;&quot;,               ; effective config hash (tstr)
    &quot;policy_hash&quot;: &quot;&lt;sha256&gt;&quot;                ; policy pack hash (tstr)
  },
  &quot;counts&quot;: {                                ; event counts (for quick triage)
    &quot;events&quot;: &lt;uint&gt;,                        ; trace_events count
    &quot;edges&quot;: &lt;uint&gt;,                         ; attack_graph edges count
    &quot;artifacts&quot;: &lt;uint&gt;                      ; evidence artifacts count
  },
  &quot;trace&quot;: {                                 ; trace evidence commitment
    &quot;mode&quot;: &quot;full&quot; | &quot;hash_only&quot;,            ; privacy mode (tstr)
    &quot;trace_cbor_hash&quot;: &quot;&lt;sha256&gt;&quot;,           ; SHA-256 of trace_events.cbor (tstr)
    &quot;trace_chain_head&quot;: &quot;&lt;sha256&gt;&quot;           ; last event_hash in window (tstr, optional)
  },
  &quot;bar&quot;: {                                   ; BAR outputs commitment
    &quot;features_hash&quot;: &quot;&lt;sha256&gt;&quot;,             ; SHA-256 of features.cbor (tstr)
    &quot;graph_hash&quot;: &quot;&lt;sha256&gt;&quot;,                ; SHA-256 of attack_graph.cbor (tstr)
    &quot;ml_hash&quot;: &quot;&lt;sha256&gt;&quot;,                   ; SHA-256 of ml_result.cbor (tstr)
    &quot;verdict_hash&quot;: &quot;&lt;sha256&gt;&quot;               ; SHA-256 of verdict.cbor (tstr)
  },
  &quot;manifest_hash&quot;: &quot;&lt;sha256&gt;&quot;,               ; SHA-256 of manifest.cbor (tstr)
  &quot;custody_log_hash&quot;: &quot;&lt;sha256&gt;&quot;,            ; SHA-256 of custody_log.cbor (tstr)
  &quot;rtsl&quot;: {                                  ; RTSL commitment
    &quot;leaf_hash&quot;: &quot;&lt;sha256&gt;&quot;,                 ; CT-style leaf hash (tstr)
    &quot;leaf_index&quot;: &lt;uint&gt;,                    ; position in log (uint, optional)
    &quot;sth_ref&quot;: &quot;&lt;sha256&gt;&quot;                    ; STH hash reference (tstr)
  },
  &quot;time&quot;: {                                  ; timestamps
    &quot;sealed_ts&quot;: &quot;&lt;RFC3339&gt;&quot;,                ; seal timestamp (tstr)
    &quot;tsa_token_hash&quot;: &quot;&lt;sha256&gt;&quot;             ; RFC 3161 token hash (tstr, optional)
  }
}
</code></pre>
<h4 id="112-hash-computation">1.1.2 Hash Computation</h4>
<p>All hashes in this spec are <strong>SHA-256</strong> unless otherwise noted.</p>
<pre><code>hash(x) = SHA-256(x)
</code></pre>
<p>For files:</p>
<pre><code>file_hash = SHA-256(file_bytes)
</code></pre>
<h3 id="12-window_pagesigcose-cose_sign1-signature">1.2 <code>window_page.sig.cose</code> — COSE_Sign1 Signature</h3>
<p>The page MUST be signed using <strong>COSE_Sign1</strong> (RFC 9052 §4.2).</p>
<p><strong>Algorithm</strong>: ES256 (ECDSA w/ SHA-256 on P-256) or EdDSA (Ed25519)<br />
<strong>Protected header</strong>:</p>
<pre><code class="language-cbor">{
  1: -7,                    ; alg: ES256 (or -8 for EdDSA)
  3: &quot;application/ritma-page+cbor&quot;  ; content type
}
</code></pre>
<p><strong>Payload</strong>: The exact bytes of <code>window_page.cbor</code><br />
<strong>External AAD</strong>: Empty</p>
<pre><code>COSE_Sign1 = [
  protected: &lt;&lt; { 1: -7, 3: &quot;application/ritma-page+cbor&quot; } &gt;&gt;,
  unprotected: {},
  payload: &lt;&lt; window_page.cbor bytes &gt;&gt;,
  signature: &lt;&lt; 64 bytes for ES256 &gt;&gt;
]
</code></pre>
<hr />
<h2 id="2-rtsl-leaf-definition-hard-rule">2. RTSL Leaf Definition (Hard Rule)</h2>
<h3 id="21-leaf-payload">2.1 Leaf Payload</h3>
<p>RTSL commits to the <strong>page hash</strong>, not raw events. The leaf payload is a minimal routing envelope:</p>
<pre><code class="language-cbor">{
  &quot;v&quot;: 2,                       ; RTSL version
  &quot;ns&quot;: &quot;&lt;namespace_id&gt;&quot;,       ; namespace
  &quot;win_id&quot;: &quot;&lt;window_id&gt;&quot;,      ; window UUID
  &quot;start&quot;: &lt;unix_ts&gt;,           ; window start (integer seconds)
  &quot;end&quot;: &lt;unix_ts&gt;,             ; window end (integer seconds)
  &quot;page_hash&quot;: &quot;&lt;sha256&gt;&quot;       ; SHA-256 of window_page.cbor
}
</code></pre>
<p><strong>Canonical encoding</strong>: Deterministic CBOR, keys sorted lexicographically.</p>
<h3 id="22-leaf-hash-ct-style-domain-separation">2.2 Leaf Hash (CT-style Domain Separation)</h3>
<pre><code>leaf_payload_bytes = canonical_cbor(leaf_payload)
leaf_hash = SHA-256(0x00 || leaf_payload_bytes)
</code></pre>
<p>The <code>0x00</code> prefix is the <strong>leaf domain separator</strong> per RFC 9162 §2.1.</p>
<h3 id="23-node-hash-merkle-tree-interior">2.3 Node Hash (Merkle Tree Interior)</h3>
<pre><code>node_hash = SHA-256(0x01 || left_hash || right_hash)
</code></pre>
<p>The <code>0x01</code> prefix is the <strong>node domain separator</strong>.</p>
<h3 id="24-signed-tree-head-sth">2.4 Signed Tree Head (STH)</h3>
<pre><code class="language-cbor">{
  &quot;v&quot;: 2,                       ; STH version
  &quot;log_id&quot;: &quot;&lt;sha256&gt;&quot;,         ; log identity (hash of log public key)
  &quot;tree_size&quot;: &lt;uint&gt;,          ; number of leaves
  &quot;root_hash&quot;: &quot;&lt;sha256&gt;&quot;,      ; Merkle root
  &quot;timestamp&quot;: &quot;&lt;RFC3339&gt;&quot;,     ; STH timestamp
  &quot;signature&quot;: &quot;&lt;base64&gt;&quot;       ; COSE_Sign1 detached signature
}
</code></pre>
<p>The STH MUST be signed with the log's signing key (same algorithm as page signatures).</p>
<hr />
<h2 id="3-proofpack-directory-layout-exact-boring-predictable">3. Proofpack Directory Layout (Exact, Boring, Predictable)</h2>
<p>When exporting a window:</p>
<pre><code>ritma export-window --ns &lt;ns&gt; --start &lt;RFC3339&gt; --end &lt;RFC3339&gt;
</code></pre>
<p>Output directory structure:</p>
<pre><code>proofpack_&lt;ns_safe&gt;_&lt;start_ts&gt;_&lt;end_ts&gt;/
├── README.txt                    # Human one-screen summary
├── window_page.cbor              # The canonical signed statement
├── window_page.sig.cose          # COSE_Sign1 signature
│
├── trace_events.cbor             # Optional (omit if hash_only mode)
├── attack_graph.cbor             # Attack graph edges
├── features.cbor                 # Window features
├── ml_result.cbor                # ML score + explanation
├── verdict.cbor                  # Verdict + reasons
│
├── manifest.cbor                 # Artifact manifest with hashes
├── custody_log.cbor              # Custody log excerpt for this window
│
├── rtsl_receipt.cbor             # STH + inclusion proof
├── keyring/
│   └── signer_pub.cosekey        # Public key for signature verification
│
└── hashes.txt                    # Human-friendly digest list (optional)
</code></pre>
<h3 id="31-file-naming-convention">3.1 File Naming Convention</h3>
<ul>
<li><code>&lt;ns_safe&gt;</code>: namespace with <code>/</code> replaced by <code>_</code>, max 64 chars</li>
<li><code>&lt;start_ts&gt;</code>, <code>&lt;end_ts&gt;</code>: Unix timestamp (integer seconds)</li>
</ul>
<p>Example:</p>
<pre><code>proofpack_ns___test_prod_app_svc_1737331200_1737331260/
</code></pre>
<h3 id="32-readmetxt-format">3.2 <code>README.txt</code> Format</h3>
<pre><code>Ritma Forensic Proofpack v2
===========================
Namespace:    ns://test/prod/app/svc
Window:       2025-01-19T12:00:00Z to 2025-01-19T12:01:00Z
Window ID:    a1b2c3d4-e5f6-7890-abcd-ef1234567890
Node:         demo-node
Sealed:       2025-01-19T12:01:05Z

Counts:
  Events:     142
  Edges:      23
  Artifacts:  5

Verification:
  ritma verify-proofpack .

Page Hash:    sha256:abc123...
RTSL Leaf:    #42 in log
STH Root:     sha256:def456...
</code></pre>
<h3 id="33-manifestcbor-structure">3.3 <code>manifest.cbor</code> Structure</h3>
<pre><code class="language-cbor">{
  &quot;v&quot;: 2,
  &quot;artifacts&quot;: [
    {
      &quot;name&quot;: &quot;trace_events.cbor&quot;,
      &quot;sha256&quot;: &quot;&lt;hash&gt;&quot;,
      &quot;size&quot;: &lt;bytes&gt;,
      &quot;cas_ref&quot;: &quot;sha256/&lt;aa&gt;/&lt;bb&gt;/&lt;hash&gt;&quot;  ; optional CAS path
    },
    ...
  ],
  &quot;privacy&quot;: {
    &quot;mode&quot;: &quot;full&quot; | &quot;hash_only&quot;,
    &quot;redactions&quot;: [&quot;pii&quot;, &quot;secrets&quot;]
  }
}
</code></pre>
<h3 id="34-rtsl_receiptcbor-structure">3.4 <code>rtsl_receipt.cbor</code> Structure</h3>
<pre><code class="language-cbor">{
  &quot;v&quot;: 2,
  &quot;leaf_index&quot;: &lt;uint&gt;,
  &quot;leaf_hash&quot;: &quot;&lt;sha256&gt;&quot;,
  &quot;inclusion_path&quot;: [
    { &quot;side&quot;: &quot;L&quot; | &quot;R&quot;, &quot;hash&quot;: &quot;&lt;sha256&gt;&quot; },
    ...
  ],
  &quot;sth&quot;: {
    &quot;tree_size&quot;: &lt;uint&gt;,
    &quot;root_hash&quot;: &quot;&lt;sha256&gt;&quot;,
    &quot;timestamp&quot;: &quot;&lt;RFC3339&gt;&quot;,
    &quot;log_id&quot;: &quot;&lt;sha256&gt;&quot;,
    &quot;signature&quot;: &quot;&lt;base64&gt;&quot;
  }
}
</code></pre>
<hr />
<h2 id="4-content-addressed-store-cas">4. Content-Addressed Store (CAS)</h2>
<h3 id="41-filesystem-cas-layout">4.1 Filesystem CAS Layout</h3>
<pre><code>RITMA_OUT/cas/sha256/&lt;aa&gt;/&lt;bb&gt;/&lt;full_hash&gt;
</code></pre>
<p>Where:
- <code>&lt;aa&gt;</code> = first 2 hex chars of hash
- <code>&lt;bb&gt;</code> = next 2 hex chars
- <code>&lt;full_hash&gt;</code> = full 64-char hex SHA-256</p>
<p>Example:</p>
<pre><code>RITMA_OUT/cas/sha256/ab/cd/abcd1234567890...
</code></pre>
<h3 id="42-cas-operations">4.2 CAS Operations</h3>
<p><strong>Store</strong>:</p>
<pre><code class="language-rust">fn cas_store(data: &amp;[u8]) -&gt; String {
    let hash = sha256(data);
    let path = format!(&quot;cas/sha256/{}/{}/{}&quot;, &amp;hash[0..2], &amp;hash[2..4], hash);
    write_if_not_exists(path, data);
    hash
}
</code></pre>
<p><strong>Retrieve</strong>:</p>
<pre><code class="language-rust">fn cas_get(hash: &amp;str) -&gt; Option&lt;Vec&lt;u8&gt;&gt; {
    let path = format!(&quot;cas/sha256/{}/{}/{}&quot;, &amp;hash[0..2], &amp;hash[2..4], hash);
    read_file(path).ok()
}
</code></pre>
<h3 id="43-proofpack-export-modes">4.3 Proofpack Export Modes</h3>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>full</code></td>
<td>Include all artifact payloads in proofpack</td>
</tr>
<tr>
<td><code>hash_only</code></td>
<td>Include only hashes; payloads stay in CAS</td>
</tr>
<tr>
<td><code>hybrid</code></td>
<td>Include small artifacts (&lt;1MB); hash large ones</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-custody-log-v2-courtaudit-friendly">5. Custody Log v2 (Court/Audit Friendly)</h2>
<h3 id="51-enhanced-schema">5.1 Enhanced Schema</h3>
<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS custody_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ts TEXT NOT NULL,                    -- RFC 3339 timestamp
    actor_id TEXT NOT NULL,              -- node_id / user / service
    session_id TEXT,                     -- ties actions within process lifetime
    tool TEXT NOT NULL,                  -- tracer_sidecar | bar_orchestrator | ritma_cli
    action TEXT NOT NULL,                -- CAPTURE|SEAL|EXPORT|PRUNE|VERIFY|ACCESS
    namespace_id TEXT,
    window_id TEXT,
    target_hash TEXT,                    -- hash of affected data
    details BLOB,                        -- CBOR (not JSON) for canonicalization
    prev_log_hash TEXT,                  -- hash chain
    log_hash TEXT NOT NULL,              -- hash of this entry
    signature TEXT,                      -- optional cryptographic signature
    tsa_token BLOB,                      -- optional RFC 3161 timestamp token
    host_attestation TEXT                -- optional TPM/IMA hash
);
</code></pre>
<h3 id="52-custody-log-entry-hash">5.2 Custody Log Entry Hash</h3>
<pre><code>entry_bytes = canonical_cbor({
  ts, actor_id, session_id, tool, action,
  namespace_id, window_id, target_hash,
  details_hash, prev_log_hash
})
log_hash = SHA-256(entry_bytes)
</code></pre>
<h3 id="53-custody_logcbor-export-format">5.3 <code>custody_log.cbor</code> Export Format</h3>
<pre><code class="language-cbor">{
  &quot;v&quot;: 2,
  &quot;entries&quot;: [
    {
      &quot;ts&quot;: &quot;&lt;RFC3339&gt;&quot;,
      &quot;actor_id&quot;: &quot;&lt;id&gt;&quot;,
      &quot;session_id&quot;: &quot;&lt;uuid&gt;&quot;,
      &quot;tool&quot;: &quot;bar_orchestrator&quot;,
      &quot;action&quot;: &quot;SEAL&quot;,
      &quot;namespace_id&quot;: &quot;&lt;ns&gt;&quot;,
      &quot;window_id&quot;: &quot;&lt;win_id&gt;&quot;,
      &quot;target_hash&quot;: &quot;&lt;sha256&gt;&quot;,
      &quot;details&quot;: { ... },
      &quot;prev_log_hash&quot;: &quot;&lt;sha256&gt;&quot;,
      &quot;log_hash&quot;: &quot;&lt;sha256&gt;&quot;
    },
    ...
  ],
  &quot;chain_valid&quot;: true
}
</code></pre>
<hr />
<h2 id="6-prune-tombstone-commitment">6. Prune Tombstone Commitment</h2>
<h3 id="61-prune-custody-entry-enhanced">6.1 Prune Custody Entry (Enhanced)</h3>
<p>When pruning, the custody log entry MUST include:</p>
<pre><code class="language-cbor">{
  &quot;action&quot;: &quot;PRUNE&quot;,
  &quot;details&quot;: {
    &quot;deleted_range&quot;: {
      &quot;ns&quot;: &quot;&lt;namespace_id&gt;&quot;,
      &quot;start&quot;: &lt;unix_ts&gt;,
      &quot;end&quot;: &lt;unix_ts&gt;,
      &quot;count&quot;: &lt;uint&gt;
    },
    &quot;deleted_events_hash&quot;: &quot;&lt;sha256&gt;&quot;,    ; hash of deleted data
    &quot;sealed_leaf_hash&quot;: &quot;&lt;sha256&gt;&quot;,       ; RTSL leaf that sealed this window
    &quot;sth_hash&quot;: &quot;&lt;sha256&gt;&quot;,               ; STH at time of seal
    &quot;tombstone_hash&quot;: &quot;&lt;sha256&gt;&quot;          ; hash of deleted_range CBOR
  }
}
</code></pre>
<h3 id="62-tombstone-hash-computation">6.2 Tombstone Hash Computation</h3>
<pre><code>tombstone_cbor = canonical_cbor({
  &quot;ns&quot;: namespace_id,
  &quot;start&quot;: start_ts,
  &quot;end&quot;: end_ts,
  &quot;count&quot;: events_count,
  &quot;deleted_events_hash&quot;: deleted_hash
})
tombstone_hash = SHA-256(tombstone_cbor)
</code></pre>
<p>This makes deletion itself <strong>auditable evidence</strong>.</p>
<hr />
<h2 id="7-cli-verification-ux">7. CLI Verification UX</h2>
<h3 id="71-ritma-verify-proofpack-dir">7.1 <code>ritma verify-proofpack &lt;dir&gt;</code></h3>
<p><strong>Steps</strong>:
1. Load <code>window_page.cbor</code> and <code>window_page.sig.cose</code>
2. Verify COSE_Sign1 signature using <code>keyring/signer_pub.cosekey</code>
3. Recompute hashes of all included payloads
4. Compare against <code>manifest.cbor</code> hashes
5. Verify <code>window_page</code> hash matches <code>rtsl_receipt.cbor</code> leaf
6. Verify inclusion proof against STH root
7. Verify custody_log hash chain</p>
<p><strong>Output</strong>:</p>
<pre><code>Ritma Proofpack Verification
============================
Page signature:     ✅ valid (ES256, signer: demo-node)
Manifest hashes:    ✅ 5/5 artifacts verified
RTSL inclusion:     ✅ leaf #42 in tree of 1000
Custody chain:      ✅ 3 entries, chain intact

Overall:            ✅ VALID
</code></pre>
<p><strong>Exit codes</strong>:
- <code>0</code>: Valid
- <code>1</code>: Tampered (signature or hash mismatch)
- <code>2</code>: Incomplete (missing files, hash-only mode)
- <code>3</code>: Error (IO, parse failure)</p>
<hr />
<h2 id="8-environment-variables-policy-knobs">8. Environment Variables (Policy Knobs)</h2>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RITMA_OUT_ENABLE</code></td>
<td><code>0</code></td>
<td>Enable RTSL output</td>
</tr>
<tr>
<td><code>RITMA_OUT_FORMAT</code></td>
<td><code>rtsl</code></td>
<td>Output format: <code>legacy</code>, <code>rtsl</code>, <code>dual</code></td>
</tr>
<tr>
<td><code>RITMA_OUT_ENFORCE_RTSL</code></td>
<td><code>0</code></td>
<td>Hard-fail if RTSL write fails</td>
</tr>
<tr>
<td><code>RITMA_PRUNE_REQUIRE_SEAL</code></td>
<td><code>1</code></td>
<td>Prune only sealed windows</td>
</tr>
<tr>
<td><code>RITMA_PRUNE_REQUIRE_EXPORT</code></td>
<td><code>0</code></td>
<td>Prune only exported windows</td>
</tr>
<tr>
<td><code>RITMA_PRUNE_MIN_AGE_SECS</code></td>
<td><code>86400</code></td>
<td>Minimum age before prune (24h)</td>
</tr>
<tr>
<td><code>RITMA_EXPORT_MODE</code></td>
<td><code>full</code></td>
<td>Export mode: <code>full</code>, <code>hash_only</code>, <code>hybrid</code></td>
</tr>
<tr>
<td><code>RITMA_CAS_ENABLE</code></td>
<td><code>1</code></td>
<td>Enable content-addressed store</td>
</tr>
<tr>
<td><code>RITMA_TSA_URL</code></td>
<td>(none)</td>
<td>RFC 3161 TSA endpoint</td>
</tr>
<tr>
<td><code>RITMA_SIGN_ALG</code></td>
<td><code>ES256</code></td>
<td>Signing algorithm: <code>ES256</code>, <code>EdDSA</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9-implementation-checklist">9. Implementation Checklist</h2>
<h3 id="phase-1-core-correctness">Phase 1: Core (Correctness)</h3>
<ul>
<li>[x] <code>window_page.cbor</code> canonical structure in <code>common_models</code> (WindowPageV2, RtslLeafPayloadV2)</li>
<li>[x] COSE_Sign1 signing (<code>ritma_contract/src/cose.rs</code>, <code>window_page.sig.cose</code>)</li>
<li>[x] RTSL leaf = <code>page_hash</code> (<code>write_window_v2_as_rtsl_record</code> in rtsl.rs)</li>
<li>[x] Snapshotter wired to CAS (<code>serialize_and_store</code> helper in snapshotter)</li>
</ul>
<h3 id="phase-2-export-usability">Phase 2: Export (Usability)</h3>
<ul>
<li>[x] <code>ritma export-window --ns --start --end</code> command (cmd_export_window)</li>
<li>[x] Proofpack directory with exact layout</li>
<li>[x] <code>manifest.cbor</code> generation (ManifestV2)</li>
<li>[x] <code>rtsl_receipt.cbor</code> with inclusion proof (generate_rtsl_receipt)</li>
</ul>
<h3 id="phase-3-verification-trust">Phase 3: Verification (Trust)</h3>
<ul>
<li>[x] <code>ritma verify-proofpack</code> command (cmd_verify_proofpack)</li>
<li>[x] Ed25519 signature verification (verify_page_signature)</li>
<li>[x] Hash verification against manifest</li>
<li>[x] Inclusion proof verification (verify_rtsl_inclusion_proof)</li>
</ul>
<h3 id="phase-4-hardening">Phase 4: Hardening</h3>
<ul>
<li>[x] Custody log v2 (session_id, tool, CBOR details) in index_db</li>
<li>[x] Prune tombstone commitment (prune_sealed_window)</li>
<li>[x] Prune guardrails (RITMA_PRUNE_REQUIRE_EXPORT, RITMA_PRUNE_MIN_AGE_SECS)</li>
<li>[x] CAS wired to snapshotter (store_to_cas, serialize_and_store helpers)</li>
<li>[x] RFC 3161 TSA integration (<code>ritma_contract/src/tsa.rs</code>, <code>RITMA_TSA_URL</code>)</li>
</ul>
<hr />
<h2 id="10-compatibility-notes">10. Compatibility Notes</h2>
<ul>
<li><strong>RTSL v1</strong> (legacy): Leaf was raw event hashes. <strong>Deprecated</strong>.</li>
<li><strong>RTSL v2</strong> (this spec): Leaf is <code>page_hash</code>. <strong>Current</strong>.</li>
<li><strong>Proofpack v1</strong>: Ad-hoc structure. <strong>Deprecated</strong>.</li>
<li><strong>Proofpack v2</strong> (this spec): Exact layout. <strong>Current</strong>.</li>
</ul>
<p>Migration: v1 data remains readable but new seals MUST use v2.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../SDK/" class="btn btn-neutral float-left" title="SDK Guide"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../RTSL_SPEC/" class="btn btn-neutral float-right" title="RTSL Spec">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../SDK/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../RTSL_SPEC/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
